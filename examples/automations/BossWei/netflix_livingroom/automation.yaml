# ============================================================
# Automation: Netflix - 情境
# Author: BossWei
# Purpose:
#   - 當 input_boolean.netflix_livingroom 被打開時
#   - 確保客廳電視已開機
#   - 將電視來源切換至 Netflix
#   - 執行完成後自動關閉 input_boolean（避免重複觸發）
# ============================================================

alias: "Netflix - 情境"
description: "客廳電視開機並自動切換至 Netflix"
mode: single

# ------------------------------------------------------------
# Trigger
# ------------------------------------------------------------
# 當「Netflix 情境」開關由 off → on 時觸發
trigger:
  - platform: state
    entity_id: input_boolean.netflix_livingroom
    from: "off"
    to: "on"

# ------------------------------------------------------------
# Conditions
# ------------------------------------------------------------
# 無額外條件（只要被觸發就執行）
condition: []

# ------------------------------------------------------------
# Actions
# ------------------------------------------------------------
action:

  # ----------------------------------------------------------
  # Step 1：若電視目前是關機或狀態不可用，先開啟電視電源
  # ----------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('media_player.lg_webos_tv_55tg')
                 in ['off','unavailable','unknown'] }}
        sequence:
          - service: switch.turn_on
            target:
              entity_id: switch.ac_d73126_2

  # ----------------------------------------------------------
  # Step 2：等待電視狀態恢復可用
  # - 避免剛開機時 media_player 尚未初始化完成
  # - 最多等待 30 秒，逾時仍繼續往下執行
  # ----------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('media_player.lg_webos_tv_55tg')
                 in ['off','unavailable','unknown'] }}
        sequence:
          - wait_template: >
              {{ states('media_player.lg_webos_tv_55tg')
                 not in ['unavailable','unknown'] }}
            timeout: "00:00:30"
            continue_on_timeout: true
          - delay: "00:00:02"   # 額外等待 2 秒，確保 TV 完全就緒

  # ----------------------------------------------------------
  # Step 3：若目前來源不是 Netflix，則切換至 Netflix
  # ----------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ (state_attr('media_player.lg_webos_tv_55tg','source')
                 | default('')) != 'Netflix' }}
        sequence:
          - service: media_player.select_source
            target:
              entity_id: media_player.lg_webos_tv_55tg
            data:
              source: "Netflix"

          # 等待來源真正切換完成（避免太快結束）
          - wait_template: >
              {{ state_attr('media_player.lg_webos_tv_55tg','source')
                 == 'Netflix' }}
            timeout: "00:00:15"
            continue_on_timeout: true

  # ----------------------------------------------------------
  # Step 4：將情境開關自動關閉，讓下次可再次觸發
  # ----------------------------------------------------------
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.netflix_livingroom
